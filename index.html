<!DOCTYPE html>
<html lang="ja" class="client-js">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikipedia (AI-Powered Demo)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #ffffff; --bg-subtle-color: #f9fafb; --text-color: #111827; --secondary-text-color: #6b7280;
            --border-color: #e5e7eb; --link-color: #6d28d9; --link-visited-color: #5b21b6; --highlight-color: #7c3aed;
            --highlight-text-color: #ffffff; --shadow-color: rgba(0, 0, 0, 0.05); --loader-color: #4f46e5;
            --error-color: #ef4444;
            /* Original gradient colors - these are now overridden by SVG gradients */
            --gradient-start: #a78bfa; 
            --gradient-end: #6d28d9;
        }
        html.dark-theme {
            --bg-color: #18181b; --bg-subtle-color: #27272a; --text-color: #e4e4e7; --secondary-text-color: #a1a1aa;
            --border-color: #3f3f46; --link-color: #93c5fd; --link-visited-color: #a78bfa; --highlight-color: #8b5cf6;
            --highlight-text-color: #ffffff; --shadow-color: rgba(0, 0, 0, 0.2); --loader-color: #a78bfa;
            --error-color: #f87171;
            /* Original gradient colors - these are now overridden by SVG gradients */
            --gradient-start: #c4b5fd; 
            --gradient-end: #8b5cf6;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--bg-subtle-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        input, textarea, button { font-family: inherit; }
        a { color: var(--link-color); text-decoration: none; transition: color 0.2s; } a:hover { color: var(--highlight-color); text-decoration: underline; }
        #mw-head { position: sticky; top: 0; height: 64px; background-color: rgba(255,255,255,0.8); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; z-index: 100; transition: background-color 0.3s, border-color 0.3s; }
        html.dark-theme #mw-head { background-color: rgba(24, 24, 27, 0.8); }
        #left-navigation, #right-navigation { display: flex; align-items: center; gap: 1rem; }
        #wikipedia-logo { display: flex; align-items: center; gap: 0.75rem; }
        #wikipedia-logo svg { color: var(--text-color); transition: color 0.3s; } .logo-text { font-weight: 700; font-size: 1.25rem; color: var(--text-color); transition: color 0.3s; }
        .input-glow-effect { border: 1px solid var(--border-color); transition: all 0.3s; }
        .input-glow-effect:focus-within { border-color: var(--highlight-color); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2); }
        html.dark-theme .input-glow-effect:focus-within { box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3); }
        #p-search { display: flex; align-items: center; background-color: var(--bg-subtle-color); border-radius: 9999px; padding-left: 1rem; }
        #p-search svg { color: var(--secondary-text-color); }
        #searchInput { width: 280px; border: none; background: none; height: 40px; color: var(--text-color); padding: 0 0.5rem 0 0.75rem; font-size: 1rem; } #searchInput:focus { outline: none; }
        #search-suggestions { position: absolute; top: 120%; left: 0; right: 0; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -4px var(--shadow-color); z-index: 110; max-height: 300px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; } .suggestion-item:hover { background-color: var(--bg-subtle-color); }
        .header-btn { display: flex; align-items: center; justify-content: center; background-color: transparent; border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; transition: all 0.2s; }
        .header-btn:hover { background-color: var(--bg-subtle-color); border-color: var(--highlight-color); }
        .header-btn svg { width: 20px; height: 20px; color: var(--text-color); }
        #content { padding: 2rem 1.5rem; }
        .mw-body { background-color: var(--bg-color); border: 1px solid var(--border-color); padding: clamp(1.5rem, 5vw, 3rem); border-radius: 16px; max-width: 1024px; margin: 0 auto; box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color); transition: background-color 0.3s, border-color 0.3s; }
        #heading-container { display: flex; align-items: center; gap: 1rem; border-bottom: 2px solid var(--border-color); margin-bottom: 1em; }
        #firstHeading { font-size: clamp(2rem, 6vw, 3rem); font-weight: 700; padding-bottom: 0.5em; margin: 0; line-height: 1.2; flex-grow: 1; }
        #bookmark-article-btn { flex-shrink: 0; margin-bottom: 0.5em; }
        #bodyContent { line-height: 1.8; font-size: 1.1rem; } #bodyContent p { margin-bottom: 1.5em; }
        .ai-section { background: linear-gradient(135deg, var(--bg-subtle-color), var(--bg-color)); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin: 2.5rem 0; }
        .ai-section-header { display: flex; align-items: center; gap: 0.75rem; font-size: 1.2em; font-weight: 500; margin-bottom: 0.75rem; }
        .ai-disclaimer { font-size: 0.85em; color: var(--secondary-text-color); margin-top: -0.25rem; margin-bottom: 1rem; padding-left: calc(20px + 0.75rem); }
        .ai-content { line-height: 1.7; position: relative; min-height: 24px; } .ai-content p { margin: 0; }
        #ai-mode-toggle { position: fixed; bottom: 2rem; right: 2rem; height: 56px; background-image: linear-gradient(to right, var(--gradient-start) 0%, var(--highlight-color) 50%, var(--gradient-end) 100%); background-size: 200% auto; color: var(--highlight-text-color); border: none; border-radius: 9999px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 0.5rem; padding: 0 1.5rem; font-size: 1rem; font-weight: 500; transition: all 0.3s ease; z-index: 1000; }
        #ai-mode-toggle:hover { background-position: right center; transform: translateY(-3px) scale(1.05); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); }
        #ai-mode-toggle svg { width: 24px; height: 24px; }
        #ai-mode-chat-window { position: fixed; bottom: 6.5rem; right: 2rem; width: 90vw; max-width: 420px; height: 70vh; max-height: 650px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: 0 20px 25px -5px var(--shadow-color), 0 8px 10px -6px var(--shadow-color); display: flex; flex-direction: column; overflow: hidden; z-index: 999; transform-origin: bottom right; transform: scale(0.95); opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; }
        #ai-mode-chat-window.visible { transform: scale(1); opacity: 1; pointer-events: auto; }
        .chat-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        .chat-message.user .message-content { background-color: var(--highlight-color); color: var(--highlight-text-color); }
        #chat-input-area { background-color: var(--bg-subtle-color); border-radius: 9999px; padding: 0.25rem 0.25rem 0.25rem 1rem; display: flex; align-items: center; margin: 0.75rem; }
        #chat-input { background-color: transparent; color: var(--text-color); border: none; flex-grow: 1; padding: 0.5rem; font-size: 1em; resize: none; max-height: 100px; }
        #chat-input:focus { outline: none; }
        #chat-send-btn { background-color: var(--highlight-color); }
        #mw-footer { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); font-size: 0.9em; color: var(--secondary-text-color); text-align: center; }
        
        /* ▼▼▼ ローディングスピナーのスタイルを変更 ▼▼▼ */
        .loader-container { display: flex; flex-direction: column; gap: 1rem; justify-content: center; align-items: center; min-height: 200px; }
        .loader {
            width: 24px;
            height: 24px;
            animation: rotate 2s linear infinite;
            transform-origin: center center;
        }
        .loader .path {
            stroke: var(--loader-color);
            stroke-linecap: round;
            animation: dash 1.5s ease-in-out infinite;
        }
        @keyframes rotate {
            100% {
                transform: rotate(360deg);
            }
        }
        @keyframes dash {
            0% {
                stroke-dasharray: 1, 150;
                stroke-dashoffset: 0;
            }
            50% {
                stroke-dasharray: 90, 150;
                stroke-dashoffset: -35;
            }
            100% {
                stroke-dasharray: 90, 150;
                stroke-dashoffset: -124;
            }
        }
        /* ▲▲▲ ローディングスピナーのスタイルを変更 ▲▲▲ */

        .error-message { color: var(--error-color); font-size: 0.9em; }
        #ai-mode-chat-window.fullscreen { top: 0; left: 0; width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh; bottom: 0; right: 0; border-radius: 0; }
        .chat-header-left, .chat-header-right { display: flex; align-items: center; gap: 0.5rem; }
        .chat-header-btn { background: none; border: none; color: var(--secondary-text-color); cursor: pointer; padding: 0.25rem; line-height: 1; display: flex; align-items: center; justify-content: center; }
        #chat-close-btn svg { width: 24px; height: 24px; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .chat-message { display: flex; flex-direction: column; max-width: 85%; } .chat-message .message-content { padding: 0.75rem 1rem; border-radius: 18px; line-height: 1.5; word-wrap: break-word; }
        .chat-message.user { align-self: flex-end; align-items: flex-end; } .chat-message.user .message-content { border-bottom-right-radius: 4px; }
        .chat-message.ai { align-self: flex-start; align-items: flex-start; } .chat-message.ai .message-content { background-color: var(--bg-subtle-color); border-bottom-left-radius: 4px; }
        #chat-send-btn { flex-shrink: 0; width: 36px; height: 36px; border-radius: 50%; border: none; color: var(--highlight-text-color); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background-color 0.2s; }
        #chat-send-btn:disabled { background-color: var(--secondary-text-color); cursor: not-allowed; }
        #api-key-modal, #bookmarks-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .api-key-dialog, .bookmarks-dialog { position: relative; background-color: var(--bg-color); padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px var(--shadow-color), 0 8px 10px -6px var(--shadow-color); }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; background: transparent; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--secondary-text-color); }
        .modal-close-btn:hover { background-color: var(--bg-subtle-color); color: var(--text-color); }
        .api-key-dialog h2, .bookmarks-dialog h2 { margin-top: 0; font-weight: 500; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1.5rem;}
        .api-key-dialog p { font-size: 0.9em; color: var(--secondary-text-color); line-height: 1.6; }
        .privacy-note { background-color: var(--bg-subtle-color); padding: 0.75rem; border-radius: 4px; border-left: 3px solid var(--highlight-color); margin: 1rem 0; }
        #api-key-input { width: 100%; padding: 0.75rem; margin-top: 1rem; box-sizing: border-box; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; }
        #api-key-error { min-height: 1.2em; margin-top: 0.5rem; }
        #save-api-key-btn, #close-bookmarks-btn { margin-top: 1.5rem; padding: 0.75rem 1.5rem; border: none; background-color: var(--highlight-color); color: var(--highlight-text-color); border-radius: 8px; font-size: 1em; cursor: pointer; width: 100%; }
        #bookmarks-list { list-style: none; padding: 0; margin: 0; max-height: 50vh; overflow-y: auto; }
        #bookmarks-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
        #bookmarks-list li:last-child { border-bottom: none; }
        #bookmarks-list a { font-weight: 500; }
        #bookmarks-list .remove-bookmark-btn { background: none; border: none; color: var(--secondary-text-color); cursor: pointer; padding: 0.5rem; border-radius: 50%; }
        #bookmarks-list .remove-bookmark-btn:hover { background-color: var(--bg-subtle-color); color: var(--error-color); }
    </style>
</head>
<body>
    <header id="mw-head">
        <div id="left-navigation">
            <a id="wikipedia-logo" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-wikipedia" viewBox="0 0 16 16"><path d="M8.835 3.003c.828-.006 2.688 0 2.688 0l.033.03v.288q0 .12-.133.12c-.433.02-.522.063-.68.29-.087.126-.258.393-.435.694l-1.52 2.843-.043.089 1.858 3.801.113.031 2.926-6.946q.152-.42-.044-.595c-.132-.114-.224-.18-.563-.195l-.275-.014a.16.16 0 0 1-.096-.035.1.1 0 0 1-.046-.084v-.289l.042-.03h3.306l.034.03v.29q0 .117-.133.117-.65.03-.962.281a1.64 1.64 0 0 0-.488.704s-2.691 6.16-3.612 8.208c-.353.672-.7.61-1.004-.019A224 224 0 0 1 8.044 8.81c-.623 1.285-1.475 3.026-1.898 3.81-.411.715-.75.622-1.02.019-.45-1.065-1.131-2.519-1.817-3.982-.735-1.569-1.475-3.149-1.943-4.272-.167-.4-.293-.657-.412-.759q-.18-.15-.746-.18Q0 3.421 0 3.341v-.303l.034-.03c.615-.003 3.594 0 3.594 0l.034.03v.288q0 .119-.15.118l-.375.016q-.483.02-.483.288-.002.125.109.4c.72 1.753 3.207 6.998 3.207 6.998l.091.023 1.603-3.197-.32-.71L6.24 5.095s-.213-.433-.286-.577l-.098-.196c-.387-.77-.411-.82-.865-.88-.137-.017-.208-.035-.208-.102v-.304l.041-.03h2.853l.075.024v.303q0 .104-.15.104l-.206.03c-.523.04-.438.254-.09.946l1.057 2.163 1.17-2.332c.195-.427.155-.534.074-.633-.046-.055-.202-.144-.54-.158l-.133-.015a.16.16 0 0 1-.096-.034.1.1 0 0 1-.045-.085v-.288l.041-.03Z"/></svg>
                <span class="logo-text">Wikipedia (AI-Powered Demo)</span>
            </a>
        </div>
        <div id="right-navigation">
            <div id="p-search" role="search" class="input-glow-effect">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/></svg>
                <input id="searchInput" placeholder="記事を検索..." title="Wikipedia内を検索 [f]" accesskey="f">
                <div id="search-suggestions"></div>
            </div>
            <button id="bookmarks-btn" class="header-btn" title="ブックマーク一覧">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bookmark-star-fill" viewBox="0 0 16 16">
                    <defs>
                        <linearGradient id="star-icon-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#4285F4" />
                            <stop offset="33%" style="stop-color:#9b72cb" />
                            <stop offset="66%" style="stop-color:#d96570" />
                            <stop offset="100%" style="stop-color:#f2a60c" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#star-icon-gradient)" fill-rule="evenodd" d="M2 15.5V2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.74.439L8 13.069l-5.26 2.87A.5.5 0 0 1 2 15.5M8.16 4.1a.178.178 0 0 0-.32 0l-.634 1.285a.18.18 0 0 1-.134.098l-1.42.206a.178.178 0 0 0-.098.303L6.58 6.993c.042.041.061.1.051.158L6.39 8.565a.178.178 0 0 0 .258.187l1.27-.668a.18.18 0 0 1 .165 0l1.27.668a.178.178 0 0 0 .257-.187L9.368 7.15a.18.18 0 0 1 .05-.158l1.028-1.001a.178.178 0 0 0-.098-.303l-1.42-.206a.18.18 0 0 1-.134-.098z"/>
                </svg>
            </button>
            <button id="api-settings-btn" class="header-btn" title="APIキー設定">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16"><path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/><path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l-.319-.094c-1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764-.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/></svg>
            </button>
        </div>
    </header>
    
    <div id="content" role="main">
        <div class="mw-body">
            <div id="heading-container">
                <h1 id="firstHeading"></h1>
                <button id="bookmark-article-btn" class="header-btn" title="この記事をブックマーク"></button>
            </div>
            <div id="bodyContent" class="mw-body-content"></div>
            <footer id="mw-footer">
                <p>この記事のテキストは<a href="https://creativecommons.org/licenses/by-sa/4.0/deed.ja" target="_blank" rel="noopener noreferrer">クリエイティブ・コモンズ 表示-継承 4.0 国際</a>ライセンスの下で利用可能です。画像については、ライセンスがそれぞれ異なるため、このデモでは表示していません。</p>
            </footer>
        </div>
    </div>

    <button id="ai-mode-toggle" title="AIとチャット">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16">
            <defs>
                <linearGradient id="ai-icon-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#4285F4" />
                    <stop offset="33%" style="stop-color:#9b72cb" />
                    <stop offset="66%" style="stop-color:#d96570" />
                    <stop offset="100%" style="stop-color:#f2a60c" />
                </linearGradient>
            </defs>
            <path fill="url(#ai-icon-gradient)" d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
        </svg>
        <span>AIとチャット</span>
    </button>
    
    <div id="ai-mode-chat-window">
        <div class="chat-header">
            <div class="chat-header-left">
                <svg width="16" height="16" viewBox="0 0 16 16">
                     <defs>
                        <linearGradient id="ai-icon-gradient-chat" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#4285F4" />
                            <stop offset="33%" style="stop-color:#9b72cb" />
                            <stop offset="66%" style="stop-color:#d96570" />
                            <stop offset="100%" style="stop-color:#f2a60c" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#ai-icon-gradient-chat)" d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
                </svg>
                <span>AI Mode</span>
            </div>
            <div class="chat-header-right">
                 <button id="clear-chat-btn" class="chat-header-btn" title="チャット履歴を削除"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button>
                 <button id="fullscreen-btn" class="chat-header-btn" title="フルスクリーン"></button>
                 <button id="chat-close-btn" class="chat-header-btn" title="閉じる"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/></svg></button>
            </div>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-area" class="input-glow-effect">
            <textarea id="chat-input" placeholder="このページについて質問する..." rows="1"></textarea>
            <button id="chat-send-btn" title="送信"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/></svg></button>
        </div>
    </div>

    <div id="api-key-modal">
        <div class="api-key-dialog">
            <button id="close-api-key-modal-btn" class="modal-close-btn" title="閉じる" aria-label="閉じる">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                </svg>
            </button>
            <h2>Gemini APIキーを設定</h2>
            <p>AI機能を利用するには、Google AI Studioで取得したAPIキーが必要です。入力されたキーは、お使いのブラウザにのみ保存されます。</p>
            <p class="privacy-note"><b>注意:</b> AI機能の利用時、表示中の記事の内容や入力した質問が、API提供元（Google）のサーバーに送信されます。</p>
            <input type="password" id="api-key-input" placeholder="ここにAPIキーを貼り付け...">
            <div id="api-key-error" class="error-message"></div>
            <button id="save-api-key-btn">保存して閉じる</button>
        </div>
    </div>
    
    <div id="bookmarks-modal">
        <div class="bookmarks-dialog">
             <button id="close-bookmarks-modal-btn" class="modal-close-btn" title="閉じる" aria-label="閉じる">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                </svg>
            </button>
            <h2>ブックマーク</h2>
            <ul id="bookmarks-list"></ul>
            <button id="close-bookmarks-btn">閉じる</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        
        const apiKeyModal = document.getElementById('api-key-modal'), apiKeyInput = document.getElementById('api-key-input'), saveApiKeyBtn = document.getElementById('save-api-key-btn'), apiKeyError = document.getElementById('api-key-error'), aiModeToggle = document.getElementById('ai-mode-toggle'), chatWindow = document.getElementById('ai-mode-chat-window'), closeChatBtn = document.getElementById('chat-close-btn'), chatMessages = document.getElementById('chat-messages'), chatInput = document.getElementById('chat-input'), chatSendBtn = document.getElementById('chat-send-btn'), fullscreenBtn = document.getElementById('fullscreen-btn'), clearChatBtn = document.getElementById('clear-chat-btn'), htmlEl = document.documentElement, bodyContent = document.getElementById('bodyContent'), firstHeading = document.getElementById('firstHeading'), searchInput = document.getElementById('searchInput'), searchSuggestions = document.getElementById('search-suggestions'), apiSettingsBtn = document.getElementById('api-settings-btn'), wikipediaLogo = document.getElementById('wikipedia-logo'), bookmarkArticleBtn = document.getElementById('bookmark-article-btn'), bookmarksBtn = document.getElementById('bookmarks-btn'), bookmarksModal = document.getElementById('bookmarks-modal'), bookmarksList = document.getElementById('bookmarks-list'), closeBookmarksBtn = document.getElementById('close-bookmarks-btn'), closeApiKeyModalBtn = document.getElementById('close-api-key-modal-btn'), closeBookmarksModalBtn = document.getElementById('close-bookmarks-modal-btn');
        
        let genAI, chat, pageContext = '', currentArticleTitle = 'メインページ', bookmarks = [];
        const BOOKMARKS_KEY = 'wikipedia_demo_bookmarks';
        const MODEL_NAME = "gemini-2.5-flash";
        const ICONS = {
            fullscreen: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-fullscreen" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5M.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5"/></svg>`,
            exitFullscreen: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-fullscreen-exit" viewBox="0 0 16 16"><path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5m5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 10 4.5v-4a.5.5 0 0 1 .5-.5M0 10.5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 6 11.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5m10 1a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0z"/></svg>`,
            // Bookmark star icon with gradient
            star: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><defs><linearGradient id="star-icon-gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#4285F4" /><stop offset="33%" style="stop-color:#9b72cb" /><stop offset="66%" style="stop-color:#d96570" /><stop offset="100%" style="stop-color:#f2a60c" /></linearGradient></defs><path fill="url(#star-icon-gradient)" d="M7.84 4.1a.178.178 0 0 1 .32 0l.634 1.285a.18.18 0 0 0 .134.098l1.42.206c.145.021.204.2.098.303L9.42 6.993a.18.18 0 0 0-.051.158l.242 1.414a.178.178 0 0 1-.258.187l-1.27-.668a.18.18 0 0 0-.165 0l-1.27.668a.178.178 0 0 1-.257-.187l.242-1.414a.18.18 0 0 0-.05-.158l-1.03-1.001a.178.178 0 0 1 .098-.303l1.42-.206a.18.18 0 0 0 .134-.098z"/><path fill="url(#star-icon-gradient)" d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1z"/></svg>`,
            starFill: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><defs><linearGradient id="star-icon-gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#4285F4" /><stop offset="33%" style="stop-color:#9b72cb" /><stop offset="66%" style="stop-color:#d96570" /><stop offset="100%" style="stop-color:#f2a60c" /></linearGradient></defs><path fill="url(#star-icon-gradient)" fill-rule="evenodd" d="M2 15.5V2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.74.439L8 13.069l-5.26 2.87A.5.5 0 0 1 2 15.5M8.16 4.1a.178.178 0 0 0-.32 0l-.634 1.285a.18.18 0 0 1-.134.098l-1.42.206a.178.178 0 0 0-.098.303L6.58 6.993c.042.041.061.1.051.158L6.39 8.565a.178.178 0 0 0 .258.187l1.27-.668a.18.18 0 0 1 .165 0l1.27.668a.178.178 0 0 0 .257-.187L9.368 7.15a.18.18 0 0 1 .05-.158l1.028-1.001a.178.178 0 0 0-.098-.303l-1.42-.206a.18.18 0 0 1-.134-.098z"/></svg>`
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            loadBookmarks();
            const apiKey = localStorage.getItem('GEMINI_API_KEY');
            initializeApp(apiKey);
            setupEventListeners();
            loadArticle(currentArticleTitle);
        });

        function setupEventListeners() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
            toggleTheme(prefersDark.matches);
            prefersDark.addEventListener('change', e => toggleTheme(e.matches));
            apiSettingsBtn.addEventListener('click', showApiKeyModal);
            saveApiKeyBtn.addEventListener('click', handleSaveApiKey);
            aiModeToggle.addEventListener('click', () => chatWindow.classList.toggle('visible'));
            closeChatBtn.addEventListener('click', () => { chatWindow.classList.remove('visible'); if (chatWindow.classList.contains('fullscreen')) toggleChatFullscreen(); });
            fullscreenBtn.addEventListener('click', toggleChatFullscreen);
            clearChatBtn.addEventListener('click', handleClearChat);
            chatSendBtn.addEventListener('click', handleSendMessage);
            searchInput.addEventListener('input', debounce(handleSearchInput, 300));
            searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') { loadArticle(e.target.value); searchSuggestions.style.display = 'none'; e.target.blur(); } });
            document.addEventListener('click', e => { if (!e.target.closest('#p-search')) searchSuggestions.style.display = 'none'; });
            wikipediaLogo.addEventListener('click', (e) => { e.preventDefault(); loadArticle('メインページ'); });
            bookmarkArticleBtn.addEventListener('click', toggleBookmark);
            bookmarksBtn.addEventListener('click', showBookmarksModal);
            closeBookmarksBtn.addEventListener('click', () => bookmarksModal.style.display = 'none');
            closeApiKeyModalBtn.addEventListener('click', () => apiKeyModal.style.display = 'none');
            closeBookmarksModalBtn.addEventListener('click', () => bookmarksModal.style.display = 'none');
        }

        function initializeApp(apiKey) {
            if (!apiKey) { genAI = null; return; }
            try { 
                genAI = new GoogleGenerativeAI(apiKey);
                genAI.getGenerativeModel({ model: MODEL_NAME }).countTokens("test");
            } catch (error) { 
                console.error("API Initialization Error:", error);
                localStorage.removeItem('GEMINI_API_KEY');
                genAI = null;
                showApiKeyModal();
                apiKeyError.textContent = "APIキーの初期化に失敗しました。キーが正しいか確認してください。";
            }
        }

        function showApiKeyModal() {
            apiKeyError.textContent = '';
            apiKeyInput.value = localStorage.getItem('GEMINI_API_KEY') || '';
            apiKeyModal.style.display = 'flex';
        }
        
        function handleSaveApiKey() {
            const key = apiKeyInput.value.trim();
            apiKeyError.textContent = '';
            if (key) {
                localStorage.setItem('GEMINI_API_KEY', key);
                initializeApp(key);
                if(genAI) {
                    apiKeyModal.style.display = 'none';
                    initializeAiFeatures();
                }
            } else {
                localStorage.removeItem('GEMINI_API_KEY');
                genAI = null;
                apiKeyError.textContent = 'APIキーが削除されました。';
                initializeAiFeatures();
            }
        }

        async function handleSearchInput() {
            const query = searchInput.value.trim();
            if (!query) { searchSuggestions.style.display = 'none'; return; }
            const endpoint = `https://ja.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(query)}&limit=10&namespace=0&format=json&origin=*`;
            try {
                const response = await fetch(endpoint);
                const data = await response.json();
                const titles = data[1];
                searchSuggestions.innerHTML = '';
                if (titles && titles.length > 0) {
                    titles.forEach(title => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.textContent = title;
                        item.onclick = () => { loadArticle(title); searchInput.value = ''; searchSuggestions.style.display = 'none'; };
                        searchSuggestions.appendChild(item);
                    });
                    searchSuggestions.style.display = 'block';
                } else { searchSuggestions.style.display = 'none'; }
            } catch (error) { console.error("Search API error:", error); searchSuggestions.style.display = 'none'; }
        }

        async function loadArticle(title) {
            currentArticleTitle = title;
            firstHeading.textContent = '読み込み中…';
            // ▼▼▼ ローディングHTMLを新しいSVGに変更 ▼▼▼
            bodyContent.innerHTML = `<div class="loader-container"><svg class="loader" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="2.5"></circle></svg><span>Wikipediaから記事を取得中...</span></div>`;
            // ▲▲▲ ローディングHTMLを新しいSVGに変更 ▲▲▲
            try {
                const articleData = await fetchWikipediaContent(title);
                const doc = new DOMParser().parseFromString(articleData.title, 'text/html');
                const cleanTitle = doc.body.textContent || '';
                firstHeading.textContent = cleanTitle;
                currentArticleTitle = cleanTitle;
                bodyContent.innerHTML = articleData.html;
                cleanArticleContent();
                document.title = `${cleanTitle} - Wikipedia Demo`;
                updateBookmarkButton();
                initializeAiFeatures();
            } catch (error) {
                console.error("Article fetch error:", error);
                firstHeading.textContent = "取得エラー";
                bodyContent.innerHTML = `<p class="error-message">記事「${title}」の取得に失敗しました。ページが存在しないか、ネットワークに問題がある可能性があります。</p>`;
            }
        }

        async function fetchWikipediaContent(pageTitle) {
            const endpoint = `https://ja.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(pageTitle)}&prop=text|displaytitle&formatversion=2&format=json&origin=*`;
            const response = await fetch(endpoint);
            if (!response.ok) throw new Error('Network response was not ok.');
            const data = await response.json();
            if (data.error) throw new Error(data.error.info);
            return { title: data.parse.displaytitle, html: data.parse.text };
        }

        function cleanArticleContent() {
            bodyContent.querySelectorAll('img, .thumb, .image, .gallery').forEach(el => el.remove());
            bodyContent.querySelectorAll('.mw-editsection, .navbox, .mw-collapsible-toggle, .mw-jump-link, .reference, .reflist, .hatnote, #toc').forEach(el => el.remove());
            bodyContent.querySelectorAll('a').forEach(a => {
                const href = a.getAttribute('href');
                if (href && (href.startsWith('./') || href.startsWith('/wiki/'))) {
                    const newTitle = decodeURIComponent(href.replace(/^(.\/|\/wiki\/)/, '')).replace(/_/g, ' ');
                    a.onclick = e => { e.preventDefault(); loadArticle(newTitle); };
                } else { if (href && !href.startsWith('#')) { a.target = '_blank'; a.rel = 'noopener noreferrer'; } }
            });
        }
        
        function initializeAiFeatures() {
            pageContext = getPageContext();
            generateAiSummary();
            initializeChat();
        }

        function getPageContext() {
            const title = firstHeading.textContent;
            const text = new DOMParser().parseFromString(bodyContent.innerHTML, 'text/html').body.textContent || "";
            return `この記事のタイトルは「${title}」です。\n記事の本文:\n${text.trim().substring(0, 15000)}`;
        }

        function generateAiSummary() {
            const existingSummary = document.getElementById('ai-summary-section');
            if(existingSummary) existingSummary.remove();
            
            const summaryContainer = document.createElement('div');
            summaryContainer.id = 'ai-summary-section';
            summaryContainer.className = 'ai-section';
            // AI概要セクションのSVGアイコンにグラデーションを適用
            const headerHTML = `<div class="ai-section-header"><svg width="20" height="20" viewBox="0 0 16 16"><defs><linearGradient id="ai-icon-gradient-summary" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#4285F4" /><stop offset="33%" style="stop-color:#9b72cb" /><stop offset="66%" style="stop-color:#d96570" /><stop offset="100%" style="stop-color:#f2a60c" /></linearGradient></defs><path fill="url(#ai-icon-gradient-summary)" d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/></svg><span>AIによる概要</span></div>`;
            const disclaimerHTML = `<p class="ai-disclaimer">AIの回答には間違いが含まれている場合があります。</p>`;
            const promptHTML = `<div class="ai-content"><p class="error-message" style="cursor:pointer;" id="prompt-set-key">AI機能を利用するには、右上の<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="display:inline-block;vertical-align:-.125em;"><path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/><path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l-.319-.094c-1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764-.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/></svg>設定ボタンからAPIキーを設定してください。</p></div>`;
            
            if (genAI) {
                summaryContainer.innerHTML = headerHTML + disclaimerHTML + `<div id="ai-summary-content" class="ai-content"></div>`;
                bodyContent.prepend(summaryContainer);
                const summaryContentEl = document.getElementById('ai-summary-content');
                const prompt = `あなたはWikipediaの専門家です。以下の記事「${currentArticleTitle}」の内容を読み、最も重要な点を3〜4文で簡潔かつ正確に要約してください。\n\n---\n${pageContext}\n---`;
                runStreamingAPI(prompt, summaryContentEl, false);
            } else {
                summaryContainer.innerHTML = headerHTML + disclaimerHTML + promptHTML;
                bodyContent.prepend(summaryContainer);
                document.getElementById('prompt-set-key').addEventListener('click', showApiKeyModal);
            }
        }
        
        function initializeChat() {
            chatMessages.innerHTML = '';
            if (!genAI) {
                addMessageToChat('ai', 'AIチャットを利用するには、右上の設定ボタンからAPIキーを設定してください。');
                chat = null;
                return;
            }
            const model = genAI.getGenerativeModel({ model: MODEL_NAME });
            const initialHistory = [{ role: "user", parts: [{ text: `あなたはWikipediaの専門家アシスタントです。これから「${currentArticleTitle}」のページに関する質問に答えてください。参考情報として記事本文を渡します。\n\n---\n${pageContext}\n---` }] }, { role: "model", parts: [{ text: `承知いたしました。「${currentArticleTitle}」の記事について、何でもご質問ください。\nAIの回答には間違いが含まれている場合がありますので、重要な情報は必ず元の記事でご確認ください。` }] }];
            chat = model.startChat({ history: initialHistory });
            addMessageToChat('ai', initialHistory[1].parts[0].text);
        }

        function handleClearChat() {
            if (confirm('チャット履歴を本当に削除しますか？')) {
                initializeChat();
            }
        }

        function toggleChatFullscreen() {
            chatWindow.classList.toggle('fullscreen');
            const isFullscreen = chatWindow.classList.contains('fullscreen');
            fullscreenBtn.innerHTML = isFullscreen ? ICONS.exitFullscreen : ICONS.fullscreen;
            fullscreenBtn.title = isFullscreen ? '元のサイズに戻す' : 'フルスクリーン';
        }
        fullscreenBtn.innerHTML = ICONS.fullscreen;

        async function runStreamingAPI(prompt, targetElement, isChat = false) {
            if (!genAI) { if(targetElement) targetElement.innerHTML = `<p class="error-message">APIキーが設定されていません。右上の設定からキーを入力してください。</p>`; return null; }
            // ▼▼▼ ローディングHTMLを新しいSVGに変更 ▼▼▼
            if (targetElement) { targetElement.innerHTML = `<div class="loader-container"><svg class="loader" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="2.5"></circle></svg></div>`; }
            // ▲▲▲ ローディングHTMLを新しいSVGに変更 ▲▲▲
            try {
                const model = genAI.getGenerativeModel({ model: MODEL_NAME });
                const result = isChat ? await chat.sendMessageStream(prompt) : await model.generateContentStream(prompt);
                let text = '';
                for await (const chunk of result.stream) {
                    if (targetElement.querySelector('.loader-container')) targetElement.innerHTML = '';
                    text += chunk.text();
                    if (targetElement) { targetElement.textContent = text; if (isChat) chatMessages.scrollTop = chatMessages.scrollHeight; }
                }
                return text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                if (targetElement) targetElement.innerHTML = `<p class="error-message">AI応答中にエラーが発生しました。APIキーやモデル設定、またはネットワーク接続を確認してください。</p>`;
                return null;
            }
        }

        function addMessageToChat(sender, textContent) {
            const messageDiv = document.createElement('div'), contentDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            contentDiv.className = 'message-content';
            contentDiv.textContent = textContent;
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return contentDiv;
        }

        async function handleSendMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText) return;
            if (!chat) {
                addMessageToChat('ai', 'AI機能を利用するにはAPIキーが必要です。右上の歯車アイコンから設定してください。');
                return;
            }
            addMessageToChat('user', messageText);
            chatInput.value = ''; chatInput.style.height = 'auto'; chatSendBtn.disabled = true;
            const aiResponseElement = addMessageToChat('ai', '');
            // ▼▼▼ ローディングHTMLを新しいSVGに変更 ▼▼▼
            aiResponseElement.innerHTML = `<div class="loader-container"><svg class="loader" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="2.5"></circle></svg></div>`;
            // ▲▲▲ ローディングHTMLを新しいSVGに変更 ▲▲▲
            await runStreamingAPI(messageText, aiResponseElement, true);
            chatSendBtn.disabled = false;
            chatInput.focus();
        }

        // --- Bookmark Functions ---
        function loadBookmarks() {
            const storedBookmarks = localStorage.getItem(BOOKMARKS_KEY);
            if (storedBookmarks) {
                bookmarks = JSON.parse(storedBookmarks);
            }
        }
        function saveBookmarks() {
            localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bookmarks));
        }
        function toggleBookmark() {
            const title = currentArticleTitle;
            const index = bookmarks.indexOf(title);
            if (index > -1) {
                bookmarks.splice(index, 1);
            } else {
                bookmarks.push(title);
            }
            saveBookmarks();
            updateBookmarkButton();
        }
        function updateBookmarkButton() {
            if (bookmarks.includes(currentArticleTitle)) {
                bookmarkArticleBtn.innerHTML = ICONS.starFill;
                bookmarkArticleBtn.title = "このブックマークを解除";
            } else {
                bookmarkArticleBtn.innerHTML = ICONS.star;
                bookmarkArticleBtn.title = "この記事をブックマーク";
            }
        }
        function showBookmarksModal() {
            renderBookmarksList();
            bookmarksModal.style.display = 'flex';
        }
        function renderBookmarksList() {
            bookmarksList.innerHTML = '';
            if (bookmarks.length === 0) {
                bookmarksList.innerHTML = '<li>ブックマークされた記事はありません。</li>';
                return;
            }
            bookmarks.forEach(title => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = title;
                a.onclick = (e) => {
                    e.preventDefault();
                    bookmarksModal.style.display = 'none';
                    loadArticle(title);
                };
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-bookmark-btn';
                removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>`;
                removeBtn.onclick = () => {
                    bookmarks = bookmarks.filter(b => b !== title);
                    saveBookmarks();
                    renderBookmarksList();
                    updateBookmarkButton();
                };
                li.appendChild(a);
                li.appendChild(removeBtn);
                bookmarksList.appendChild(li);
            });
        }
        
        function toggleTheme(isDark) { htmlEl.classList.toggle('dark-theme', isDark); }
        function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
    </script>
</body>
</html>
